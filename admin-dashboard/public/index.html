<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Milo Bot - Dashboard de Estad√≠sticas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .last-update {
            color: #666;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-container h2 {
            color: #333;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }

        .filter-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .filter-section label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .filter-section input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .filter-section button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .filter-section button:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Milo Bot - Dashboard de Estad√≠sticas</h1>
            <div class="last-update" id="lastUpdate">Cargando...</div>
        </header>

        <div class="filter-section">
            <label>Filtrar por fecha:</label>
            <input type="date" id="startDate" />
            <input type="date" id="endDate" />
            <button onclick="applyFilters()">Aplicar Filtros</button>
            <button onclick="clearFilters()">Limpiar</button>
        </div>

        <div class="stats-grid" id="summaryCards"></div>

        <div class="chart-container">
            <h2>üìà Estad√≠sticas por M√≥dulo</h2>
            <div id="moduleStats">
                <div class="loading">Cargando...</div>
            </div>
        </div>

        <div class="chart-container">
            <h2>üî• Eventos M√°s Frecuentes</h2>
            <div id="topEvents">
                <div class="loading">Cargando...</div>
            </div>
        </div>

        <div class="chart-container">
            <h2>üë• Usuarios Activos (√öltimos 7 d√≠as)</h2>
            <div id="activeUsers">
                <div class="loading">Cargando...</div>
            </div>
        </div>

        <div class="chart-container">
            <h2>üìÖ Estad√≠sticas Diarias</h2>
            <div id="dailyStats">
                <div class="loading">Cargando...</div>
            </div>
        </div>

        <div class="chart-container">
            <h2>üåç Estad√≠sticas Geogr√°ficas</h2>
            <div id="geographicStats">
                <div class="loading">Cargando...</div>
            </div>
        </div>

        <div class="chart-container">
            <h2>üåé Estad√≠sticas por Pa√≠s</h2>
            <div id="countryStats">
                <div class="loading">Cargando...</div>
            </div>
        </div>

        <div class="chart-container">
            <h2>üèôÔ∏è Estad√≠sticas por Ciudad</h2>
            <div id="cityStats">
                <div class="loading">Cargando...</div>
            </div>
        </div>
    </div>

    <script>
        let startDate = null;
        let endDate = null;

        async function fetchData(url) {
            try {
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                
                const fullUrl = params.toString() ? `${url}?${params.toString()}` : url;
                const response = await fetch(fullUrl);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                return { success: false, error: error.message };
            }
        }

        async function loadSummary() {
            const data = await fetchData('/api/summary');
            if (data.success) {
                const cards = document.getElementById('summaryCards');
                cards.innerHTML = `
                    <div class="stat-card">
                        <h3>Total Usuarios</h3>
                        <div class="value">${data.data.totalUsers}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Usuarios Activos (7 d√≠as)</h3>
                        <div class="value">${data.data.activeUsersLast7Days}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Eventos</h3>
                        <div class="value">${data.data.totalEvents}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Gastos</h3>
                        <div class="value">${data.data.totalExpenses}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Grupos</h3>
                        <div class="value">${data.data.totalGroups}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Eventos Trackeados</h3>
                        <div class="value">${data.data.totalStats}</div>
                    </div>
                `;
            }
        }

        async function loadModuleStats() {
            const data = await fetchData('/api/stats/modules');
            if (data.success) {
                const container = document.getElementById('moduleStats');
                const modules = data.data;
                let html = '<table><tr><th>M√≥dulo</th><th>Eventos</th></tr>';
                for (const [module, count] of Object.entries(modules)) {
                    html += `<tr><td>${module}</td><td>${count}</td></tr>`;
                }
                html += '</table>';
                container.innerHTML = html;
            } else {
                document.getElementById('moduleStats').innerHTML = `<div class="error">Error: ${data.error}</div>`;
            }
        }

        async function loadTopEvents() {
            const data = await fetchData('/api/stats/top-events?limit=10');
            if (data.success) {
                const container = document.getElementById('topEvents');
                let html = '<table><tr><th>Evento</th><th>Cantidad</th><th>Usuarios √önicos</th></tr>';
                data.data.forEach(event => {
                    html += `<tr><td>${event.event_type}</td><td>${event.count}</td><td>${event.unique_users}</td></tr>`;
                });
                html += '</table>';
                container.innerHTML = html;
            } else {
                document.getElementById('topEvents').innerHTML = `<div class="error">Error: ${data.error}</div>`;
            }
        }

        async function loadActiveUsers() {
            const data = await fetchData('/api/stats/active-users?days=7');
            if (data.success) {
                const container = document.getElementById('activeUsers');
                let html = '<table><tr><th>Usuario</th><th>Tel√©fono</th><th>Eventos</th><th>√öltima Actividad</th></tr>';
                data.data.slice(0, 20).forEach(user => {
                    // Formatear tel√©fono: eliminar @lid, @c.us, etc.
                    const phone = (user.formatted_phone || user.user_phone || '').replace('@lid', '').replace('@c.us', '').replace('@g.us', '');
                    const displayName = user.user_name || 'Usuario sin nombre';
                    const displayPhone = phone || user.user_phone || 'N/A';
                    html += `<tr><td>${displayName}</td><td>${displayPhone}</td><td>${user.event_count}</td><td>${new Date(user.last_activity).toLocaleString()}</td></tr>`;
                });
                html += '</table>';
                container.innerHTML = html;
            } else {
                document.getElementById('activeUsers').innerHTML = `<div class="error">Error: ${data.error}</div>`;
            }
        }

        async function loadDailyStats() {
            const data = await fetchData('/api/stats/daily?days=7');
            if (data.success) {
                const container = document.getElementById('dailyStats');
                let html = '<table><tr><th>Fecha</th><th>Eventos</th><th>Usuarios √önicos</th><th>Eventos √önicos</th></tr>';
                data.data.forEach(stat => {
                    html += `<tr><td>${stat.date}</td><td>${stat.event_count}</td><td>${stat.unique_users}</td><td>${stat.unique_events}</td></tr>`;
                });
                html += '</table>';
                container.innerHTML = html;
            } else {
                document.getElementById('dailyStats').innerHTML = `<div class="error">Error: ${data.error}</div>`;
            }
        }

        async function loadGeographicStats() {
            const data = await fetchData('/api/stats/geographic');
            if (data.success) {
                const container = document.getElementById('geographicStats');
                const stats = data.data;
                let html = '<div style="margin-bottom: 20px;">';
                html += `<p><strong>Usuarios con ubicaci√≥n:</strong> ${stats.usersWithLocation}</p>`;
                html += `<p><strong>Usuarios sin ubicaci√≥n:</strong> ${stats.usersWithoutLocation}</p>`;
                html += `<p><strong>Pa√≠ses √∫nicos:</strong> ${stats.uniqueCountries}</p>`;
                html += `<p><strong>Ciudades √∫nicas:</strong> ${stats.uniqueCities}</p>`;
                html += '</div>';
                
                if (stats.topCountries && stats.topCountries.length > 0) {
                    html += '<h3>Top 5 Pa√≠ses</h3><table><tr><th>Pa√≠s</th><th>C√≥digo</th><th>Usuarios</th><th>Eventos</th></tr>';
                    stats.topCountries.forEach(country => {
                        html += `<tr><td>${country.country || 'Unknown'}</td><td>${country.country_code || 'N/A'}</td><td>${country.user_count}</td><td>${country.event_count}</td></tr>`;
                    });
                    html += '</table>';
                }
                
                if (stats.topCities && stats.topCities.length > 0) {
                    html += '<h3 style="margin-top: 20px;">Top 5 Ciudades</h3><table><tr><th>Ciudad</th><th>Estado</th><th>Pa√≠s</th><th>Usuarios</th><th>Eventos</th></tr>';
                    stats.topCities.forEach(city => {
                        html += `<tr><td>${city.city || 'Unknown'}</td><td>${city.state || 'N/A'}</td><td>${city.country || 'N/A'}</td><td>${city.user_count}</td><td>${city.event_count}</td></tr>`;
                    });
                    html += '</table>';
                }
                
                container.innerHTML = html;
            } else {
                document.getElementById('geographicStats').innerHTML = `<div class="error">Error: ${data.error}</div>`;
            }
        }

        async function loadCountryStats() {
            const data = await fetchData('/api/stats/by-country');
            if (data.success) {
                const container = document.getElementById('countryStats');
                let html = '<table><tr><th>Pa√≠s</th><th>C√≥digo</th><th>Usuarios</th><th>Eventos</th></tr>';
                data.data.forEach(country => {
                    html += `<tr><td>${country.country || 'Unknown'}</td><td>${country.country_code || 'N/A'}</td><td>${country.user_count}</td><td>${country.event_count}</td></tr>`;
                });
                html += '</table>';
                container.innerHTML = html;
            } else {
                document.getElementById('countryStats').innerHTML = `<div class="error">Error: ${data.error}</div>`;
            }
        }

        async function loadCityStats() {
            const data = await fetchData('/api/stats/by-city?limit=20');
            if (data.success) {
                const container = document.getElementById('cityStats');
                let html = '<table><tr><th>Ciudad</th><th>Estado</th><th>Pa√≠s</th><th>Usuarios</th><th>Eventos</th></tr>';
                data.data.forEach(city => {
                    html += `<tr><td>${city.city || 'Unknown'}</td><td>${city.state || 'N/A'}</td><td>${city.country || 'N/A'}</td><td>${city.user_count}</td><td>${city.event_count}</td></tr>`;
                });
                html += '</table>';
                container.innerHTML = html;
            } else {
                document.getElementById('cityStats').innerHTML = `<div class="error">Error: ${data.error}</div>`;
            }
        }

        function applyFilters() {
            startDate = document.getElementById('startDate').value || null;
            endDate = document.getElementById('endDate').value || null;
            loadAllData();
        }

        function clearFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            startDate = null;
            endDate = null;
            loadAllData();
        }

        async function loadAllData() {
            await Promise.all([
                loadSummary(),
                loadModuleStats(),
                loadTopEvents(),
                loadActiveUsers(),
                loadDailyStats(),
                loadGeographicStats(),
                loadCountryStats(),
                loadCityStats()
            ]);
            document.getElementById('lastUpdate').textContent = `√öltima actualizaci√≥n: ${new Date().toLocaleString()}`;
        }

        // Cargar datos al iniciar
        loadAllData();

        // Auto-refresh cada 30 segundos
        setInterval(loadAllData, 30000);
    </script>
</body>
</html>

